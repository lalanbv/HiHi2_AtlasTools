# 材质图集替换器（Material Atlas Replacer）

## 概述

材质图集替换器是配合图集生成器使用的自动化工具，用于批量将材质球上的散图纹理替换为图集纹理，并自动计算和设置正确的 UV Tiling 和 Offset。工具支持自动/自定义双模式，提供详细的分析和预览功能。

## 功能特性

### 核心功能
- **批量材质替换**：一次性处理多个材质文件
- **自动 UV 计算**：根据图集配置自动计算 Tiling 和 Offset
- **智能匹配**：按纹理名称自动匹配图集中的 Sprite
- **材质拷贝保护**：替换前自动拷贝材质，保护原始文件
- **双路径模式**：支持自动模式和自定义模式
- **详细分析报告**：预先分析哪些纹理可替换，哪些无法匹配
- **可视化结果**：彩色标记可替换/不可替换的材质和纹理

### 路径模式

#### 自动模式（Auto Mode）
- **材质源路径**：选中的 Material 文件夹
- **图集配置路径**：自动查找 `[父级目录]/Lod/Texture`
- **材质输出路径**：自动生成为 `[父级目录]/Lod/Materials`
- **适用场景**：标准项目结构，快速完成替换

#### 自定义模式（Custom Mode）
- **材质球源路径**：自由选择材质源文件夹
- **图集配置路径**：自由选择图集配置所在文件夹
- **新材质保存路径**：自由选择新材质保存位置
- **适用场景**：非标准项目结构，灵活配置路径

## 使用方法

### 方式一：快捷菜单（推荐用于自动模式）
1. 在 Project 窗口中选中 Material 文件夹
2. 右键 → `图集生成替换` → `材质图集替换`
3. 窗口自动打开并：
   - 自动填充材质文件夹路径
   - 自动查找图集配置文件夹
   - 自动执行分析（如果找到配置）

### 方式二：工具菜单
1. 顶部菜单栏 → `Tools` → `图集生成替换` → `材质图集替换工具`
2. 根据需要选择路径模式并手动配置

### 操作步骤

#### 标准流程（自动模式）
1. **确认路径**：检查自动识别的路径是否正确
2. **查看图集配置列表**：确认已加载正确的 AtlasConfig
3. **点击「分析材质」**：查看可替换的纹理统计
4. **查看分析结果**：
   - 展开每个材质查看详细替换信息
   - 绿色标记表示可替换
   - 橙色标记表示无法在图集中找到
5. **点击「应用替换」**：执行替换操作

#### 自定义流程（自定义模式）
1. **切换到自定义模式**
2. **选择材质球源路径**：拖拽或点击「选择」按钮
3. **选择图集配置路径**：选择包含 AtlasConfig 的文件夹
4. **点击「重新查找」**：加载图集配置
5. **选择新材质保存路径**：指定输出文件夹
6. **后续步骤同自动模式**

## 界面说明

### 路径配置区域

#### 自动模式显示
- **材质文件夹**：当前操作的材质文件夹（禁用编辑）
- **输出路径**：自动计算的新材质保存路径
- **图集配置文件夹**：自动查找的图集配置路径
- **重新查找按钮**：手动重新扫描图集配置

#### 自定义模式显示
- **材质球源路径**：支持拖拽和按钮选择
- **图集配置文件夹**：支持拖拽和按钮选择
- **新材质保存路径**：支持拖拽和按钮选择
- **重新查找按钮**：重新扫描图集配置

### 图集配置列表
展开后显示：
- 每个 AtlasConfig 的名称和路径
- 对应的图集纹理名称
- 包含的图片数量
- 点击「定位」可在 Project 中高亮

### 收集到的材质列表
显示从源文件夹收集的所有材质：
- 材质名称和对象引用
- 点击「定位」可在 Project 中高亮

### 分析结果区域
- **筛选选项**：「仅显示可替换」开关
- **材质折叠面板**：
  - 绿色背景：包含可替换纹理
  - 灰色背景：无可替换纹理
  - 显示可替换纹理数量

#### 替换信息详情
每个纹理属性显示：
- **属性名称**：如 _MainTex、_BumpMap 等
- **原始纹理**：当前材质使用的纹理对象
- **替换状态**：
  - ✓ 绿色：找到匹配，显示 UV 信息
  - ⚠ 橙色：图集中未找到

**可替换纹理显示**：
- Offset (偏移)：UV 坐标的起始点
- Tiling (缩放)：UV 坐标的宽高比例

## 技术原理

### 匹配逻辑
1. 遍历材质的所有 Texture 属性
2. 获取属性当前绑定的纹理名称
3. 在所有 AtlasConfig 中查找同名 Sprite
4. 匹配成功则标记为可替换

### UV 计算
基于 AtlasConfig 中存储的 SpriteInfo：
csharp
Rect uvRect = spriteInfo.uvRect;
Vector2 tiling = new Vector2(uvRect.width, uvRect.height);
Vector2 offset = new Vector2(uvRect.x, uvRect.y);

### 材质替换流程
1. **拷贝材质**：从源路径拷贝到输出路径
2. **分析拷贝后的材质**：重新分析可替换纹理
3. **执行替换**：
   - `material.SetTexture(propertyName, atlasTexture)`
   - `material.SetVector(propertyName + "_ST", new Vector4(tiling.x, tiling.y, offset.x, offset.y))`
4. **保存和刷新**：标记脏数据并刷新 AssetDatabase

### 材质拷贝机制
- **原因**：保护原始材质不被修改
- **策略**：删除旧的输出文件夹，重新创建并拷贝
- **安全性**：只修改输出路径下的材质副本

## 配置要求

### 前置条件
1. 已使用图集生成器生成图集和配置文件
2. 图集配置（AtlasConfig）与材质在合理的相对路径下
3. 材质文件可访问且未被锁定

### 路径约定（自动模式）
假设项目结构为：
Clothing_Dress_001/ 
├── Material/ ← 材质源文件夹 
│ ├── Dress.mat 
│ └── Ribbon.mat 
├── Texture/ ← 贴图源文件夹 
│ ├── Dress_Albedo.png 
│ └── Ribbon_Albedo.png 
└── Lod/ ← 自动生成 
├── Texture/ ← 图集配置路径 
│ ├── Dress_0.png 
│ └── Dress_0.asset 
└── Materials/ ← 材质输出路径 
├── Dress.mat 
└── Ribbon.mat

## 注意事项

### 属性命名约定
- 工具通过 `_ST` 后缀自动设置 Tiling/Offset
- 大部分 Unity 标准 Shader 遵循此约定（如 `_MainTex_ST`）
- 自定义 Shader 需确保属性名符合规范

### 法线贴图处理
- 图集生成器会跳过法线贴图
- 替换器不会替换未打入图集的纹理
- 法线贴图保持原样引用

### 不可替换的情况
- 纹理名称在图集中不存在
- 纹理是法线贴图（被跳过）
- 材质的 Shader 不支持 Tiling/Offset

### 性能影响
- 替换操作不影响运行时性能
- 图集纹理减少 Draw Call（需配合合并网格使用）
- 内存占用取决于图集尺寸

## 常见问题

### Q1: 为什么某些纹理显示「图集中未找到」？
**A:** 
- 检查纹理名称是否与图集生成时一致
- 确认该纹理是否被图集生成器跳过（如法线贴图）
- 查看图集配置的 spriteInfos 列表

### Q2: 替换后材质显示异常？
**A:** 
- 检查材质的 Shader 是否支持 `_ST` 属性
- 查看 Console 日志是否有错误
- 确认图集纹理的 sRGB 设置是否正确

### Q3: 自动模式找不到图集配置？
**A:** 
- 确认路径结构符合 `[父级]/Lod/Texture` 约定
- 点击「重新查找」按钮
- 切换到自定义模式手动选择路径

### Q4: 如何恢复原始材质？
**A:** 
- 原始材质保持不变（在 Material 文件夹）
- 删除 Lod/Materials 文件夹即可
- 或从版本控制系统恢复

### Q5: 是否支持多个图集配置？
**A:** 支持。工具会自动加载指定文件夹下的所有 AtlasConfig，按顺序匹配。

## 最佳实践

1. **先生成后替换**：确保图集生成成功后再执行替换
2. **检查分析结果**：替换前仔细查看分析报告
3. **使用版本控制**：替换前提交原始材质
4. **分批处理**：大量材质建议分批处理，便于排查问题
5. **保留配置**：保存常用的 AtlasGeneratorSettings 配置

## 日志解读

### 成功日志（绿色）
<color=green>Material copy completed!</color> Copied 5/5 materials
<color=cyan>Copied material:</color> Dress.mat -> Lod/Materials/Dress.mat
<color=cyan>已替换材质 [Dress] 属性 [_MainTex]:</color>
纹理: Dress_Albedo -> Dress_0
Tiling: (0.2500, 0.5000)
Offset: (0.0000, 0.5000)

### 警告日志（黄色）
⚠ 警告: 未找到图集配置文件
材质 [Dress] 的纹理 [Detail_Texture] 在图集中未找到，跳过

### 错误日志（红色）
✗ 错误: 材质拷贝失败
Failed to create output folder: Assets/Invalid/Path

## 版本历史

### v3.0（当前版本）
- ✨ 新增自定义路径模式
- ✨ 新增详细的分析结果可视化
- ✨ 新增「仅显示可替换」筛选功能
- 🔧 优化路径选择交互，支持拖拽 DefaultAsset
- 🔧 改进图集配置自动查找逻辑
- 🐛 修复自定义模式文件定位缺陷

### v2.0
- ✨ 添加材质拷贝保护机制
- ✨ 支持多图集配置匹配
- 🔧 优化 UV 计算精度

### v1.0
- 🎉 初始版本发布
- ✅ 基础材质替换功能

## 相关工具

- **图集生成器**：生成图集和配置文件
- **一键图集处理器**：一键完成图集生成和材质替换

---

**开发者**: HiHi2 Atlas Tools Team  
**最后更新**: 2026-01