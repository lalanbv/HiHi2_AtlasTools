# 一键图集处理器（One-Click Atlas Processor）

## 概述

一键图集处理器是 HiHi2 Atlas Tools 的旗舰功能，集成了图集生成和材质替换的完整流程，实现真正的"一键式"自动化处理。工具自动检测项目结构，按顺序执行所有必要步骤，并提供详细的进度反馈和日志记录。

## 功能特性

### 核心优势
- **完全自动化**：一个按钮完成全部流程
- **智能结构检测**：自动识别 Material 和 Texture 文件夹
- **双路径模式**：支持自动/自定义模式，适配不同项目结构
- **实时进度反馈**：4 步流程进度显示
- **详细日志记录**：每步操作都有时间戳和结果记录
- **错误恢复机制**：任意步骤失败都会中止并报告

### 工作流程（4 步）
1. **Step 1/4**: 收集纹理文件
2. **Step 2/4**: 执行图集打包算法
3. **Step 3/4**: 保存图集到磁盘
4. **Step 4/4**: 拷贝材质并执行纹理替换

### 路径模式

#### 自动模式（Auto Mode）
- **前提条件**：项目文件夹包含 `Material/` 和 `Texture/` 子文件夹
- **输入路径**：选择项目根目录
- **自动推导**：
  - Texture 源路径：`[根目录]/Texture`
  - Material 源路径：`[根目录]/Material`
  - 图集输出路径：`[根目录]/Lod/Texture`
  - 材质输出路径：`[根目录]/Lod/Materials`
- **适用场景**：标准服装项目结构

#### 自定义模式（Custom Mode）
- **完全自由配置**：
  - Texture 源路径
  - 材质球源路径
  - 图集输出路径
  - 新材质保存路径
- **适用场景**：非标准项目结构、跨目录操作

## 使用方法

### 方式一：快捷菜单（推荐用于自动模式）
1. 在 Project 窗口选中项目根目录文件夹
2. 右键 → `图集生成替换` → `一键图集生成与材质替换`
3. 窗口自动打开并：
   - 检测 Material 和 Texture 文件夹
   - 显示结构检测结果
   - 自动加载默认配置

### 方式二：工具菜单
1. 顶部菜单栏 → `Tools` → `图集生成替换` → `一键图集生成与材质替换工具`
2. 根据需要选择路径模式并手动配置

### 标准项目结构

一键处理器期望的标准结构：
Clothing_Dress_001/ ← 选中此文件夹 
├── Material/ ← 必需：材质文件夹 
│ ├── Dress.mat 
│ └── Ribbon.mat 
├── Texture/ ← 必需：贴图文件夹 
│ ├── Dress_Albedo.png 
│ ├── Dress_Normal.png 
│ ├── Ribbon_Albedo.png 
│ └── Ribbon_Normal.png 
└── Lod/ ← 自动生成 
├── Texture/ ← 图集和配置 
│ ├── Dress_0.png 
│ └── Dress_0.asset 
└── Materials/ ← 替换后的材质 
├── Dress.mat 
└── Ribbon.mat

## 操作步骤

### 自动模式流程
1. **选择项目根目录**：
   - 在 Project 中右键文件夹，或
   - 在窗口中拖拽文件夹到「项目根目录」字段
2. **检查结构检测结果**：
   - 绿色提示：结构完整，可以执行
   - 黄色警告：缺少必要文件夹，请创建或切换到自定义模式
3. **配置图集参数**：
   - 使用默认设置或自定义调整
   - 重点关注 Padding、最大空白率、最大尺寸
4. **点击「执行一键处理」**：
   - 确认对话框提示
   - 查看实时进度和日志
5. **查看完成结果**：
   - 检查 Lod/Texture 文件夹下的图集
   - 检查 Lod/Materials 文件夹下的新材质

### 自定义模式流程
1. **切换到自定义模式**
2. **配置所有路径**：
   - Texture 源路径（拖拽或选择）
   - 材质球源路径（拖拽或选择）
   - 图集输出路径（拖拽或选择）
   - 新材质保存路径（拖拽或选择）
3. **配置图集参数**
4. **执行一键处理**
5. **查看完成结果**

## 界面说明

### 路径模式选择器
- **自动模式**（绿色按钮）：适用于标准结构
- **自定义模式**（青色按钮）：适用于自定义结构

### 路径配置区域

#### 自动模式显示
- **项目根目录**：只读，显示当前项目路径
- **材质路径**：只读，自动推导的 Material 路径
- **贴图路径**：只读，自动推导的 Texture 路径
- **结构检测提示**：
  - 绿色：检测成功
  - 黄色：缺少必要文件夹

#### 自定义模式显示
- **Texture 源路径**：可拖拽，可点击「选择」按钮
- **材质球源路径**：可拖拽，可点击「选择」按钮
- **图集输出路径**：可拖拽，可点击「选择」按钮
- **新材质保存路径**：可拖拽，可点击「选择」按钮

### 图集参数配置
| 参数 | 说明 | 推荐值 |
|-----|------|--------|
| **间距 (Padding)** | 图片间距像素 | 2 |
| **最大空白率 %** | 允许的空白百分比 | 15% |
| **最大图集尺寸** | 图集最大边长 | 2048 |
| **允许多图集** | 是否允许生成多张图集 | 启用 |

### 执行日志区域
显示每步操作的：
- 时间戳
- 操作描述
- 进度百分比
- 成功/失败/警告标记

## 技术流程

### Step 1: 收集纹理文件
[进度 0.1-0.2]
- 扫描 Texture 源路径
- 过滤法线贴图
- 设置纹理可读性
- 返回 TextureInfo 列表

### Step 2: 执行图集打包
- [进度 0.25-0.4]
- 准备可读纹理副本
- 应用降维（预留 Padding 空间）
- 执行 MaxRects 装箱算法
- 生成图集纹理预览

### Step 3: 保存图集到磁盘
[进度 0.5-0.6]
- 创建输出文件夹
- 编码 PNG 并写入磁盘
- 配置纹理导入设置
- 创建 AtlasConfig 资源
- 保存 Sprite UV 数据

### Step 4: 拷贝材质并替换
[进度 0.65-0.95]
- 加载图集配置文件
- 收集源材质列表
- 拷贝材质到输出路径
- 分析材质纹理引用
- 替换为图集纹理并设置 UV
- 保存修改

### 完成
[进度 1.0]
- 显示统计信息
- 刷新 AssetDatabase
- 显示完成对话框

## 错误处理

### 常见错误及解决方案

#### 错误：「纹理源路径无效」
**原因**：Texture 文件夹不存在或路径错误  
**解决**：
- 检查项目结构是否符合标准
- 切换到自定义模式手动选择正确路径

#### 错误：「材质源路径无效」
**原因**：Material 文件夹不存在或路径错误  
**解决**：同上

#### 错误：「未找到可用纹理」
**原因**：Texture 文件夹为空或只包含法线贴图  
**解决**：
- 确认文件夹包含有效的 Albedo/Diffuse 贴图
- 检查纹理导入设置

#### 错误：「根据当前参数无法生成图集」
**原因**：图集参数设置过于严格  
**解决**：
- 增加最大空白率
- 提高最大图集尺寸
- 启用多图集模式
- 减小 Padding 值

#### 警告：「未找到图集配置文件」
**原因**：图集生成成功但配置文件丢失  
**解决**：
- 检查输出文件夹权限
- 查看 Console 详细错误日志
- 重新执行流程

#### 警告：「未找到材质文件」
**原因**：Material 文件夹为空  
**解决**：
- 确认材质文件存在
- 检查材质文件扩展名为 .mat

#### 错误：「材质拷贝失败」
**原因**：输出路径无写入权限或磁盘空间不足  
**解决**：
- 检查文件夹权限
- 确保磁盘有足够空间
- 关闭占用输出文件夹的其他程序

## 日志示例

### 成功执行日志
[14:23:45] 开始一键处理流程... 
[14:23:45] Step 1/4: 收集纹理文件... 
[14:23:46] Step 1/4: 找到 8 张纹理 
[14:23:46] Step 2/4: 准备纹理数据... 
[14:23:47] Step 2/4: 执行图集打包算法... 
[14:23:48] Step 2/4: 成功生成 1 张图集 
[14:23:48] Step 3/4: 保存图集到磁盘... 
[14:23:49] Step 3/4: 图集已保存到 Assets/Dress/Lod/Texture 
[14:23:49] Step 4/4: 加载图集配置... 
[14:23:49] Step 4/4: 加载了 1 个图集配置 
[14:23:50] Step 4/4: 拷贝 2 个材质... 
[14:23:50] Step 4/4: 分析材质纹理引用... 
[14:23:51] Step 4/4: 执行纹理替换... 
[14:23:52] Step 4/4: 完成！替换了 2 个材质中的 4 张纹理 
[14:23:52] ✓ 一键处理完成！

### 失败日志示例
[14:30:12] 开始一键处理流程... 
[14:30:12] Step 1/4: 收集纹理文件... 
[14:30:12] ✗ 错误: 未在 Assets/Dress/Texture 找到可用纹理

## 性能和限制

### 性能特征
- **小型项目**（10-30 张纹理）：3-10 秒
- **中型项目**（30-100 张纹理）：10-30 秒
- **大型项目**（100+ 张纹理）：30-60 秒

### 推荐配置
- **每个项目纹理数量**：10-50 张
- **单张纹理尺寸**：256x256 到 1024x1024
- **生成图集尺寸**：1024x1024 或 2048x2048

### 系统要求
- Unity 2020.3 或更高版本
- 足够的磁盘空间（至少图集大小的 3 倍）
- 项目已启用 C# 7.0+

## 最佳实践

1. **使用版本控制**：处理前提交原始文件
2. **检查结构**：确保文件夹命名和结构正确
3. **测试参数**：先用小项目测试配置参数
4. **批量处理**：相似项目使用相同的参数设置
5. **保留配置**：保存常用的 AtlasGeneratorSettings 资源
6. **定期清理**：删除不再使用的 Lod 文件夹

## 与其他工具对比

| 特性 | 一键处理器 | 图集生成器 + 材质替换器 |
|------|-----------|----------------------|
| **操作步骤** | 1 步 | 2 步 |
| **自动化程度** | 全自动 | 半自动 |
| **灵活性** | 中等 | 高 |
| **预览功能** | 无 | 有 |
| **适用场景** | 批量生产 | 调试优化 |
| **学习成本** | 低 | 中 |

**建议**：
- 日常批量生产：使用一键处理器
- 参数调优：使用图集生成器预览
- 问题排查：使用材质替换器查看详情

## 常见问题

### Q1: 一键处理失败如何排查？
**A:** 
1. 查看执行日志的具体错误信息
2. 分别使用图集生成器和材质替换器测试
3. 检查 Console 是否有详细错误堆栈

### Q2: 可以重复执行吗？
**A:** 可以。工具会自动删除旧的 Lod 文件夹并重新生成。

### Q3: 执行中断如何恢复？
**A:** 删除 Lod 文件夹，重新执行一键处理。

### Q4: 是否支持撤销？
**A:** 
- 原始材质和纹理不受影响
- 删除 Lod 文件夹即可恢复
- 建议使用版本控制系统

### Q5: 自定义模式和自动模式有何区别？
**A:** 
- 自动模式：路径自动推导，适合标准结构
- 自定义模式：完全自定义路径，适合特殊需求

## 版本历史

### v3.0（当前版本）
- ✨ 新增自定义路径模式
- ✨ 新增实时进度反馈
- ✨ 新增详细的时间戳日志
- 🔧 优化路径验证逻辑
- 🔧 改进错误报告机制
- 🐛 修复路径选择不生效问题

### v2.0
- ✨ 引入 4 步流程设计
- ✨ 添加结构自动检测
- 🔧 优化流程衔接逻辑

### v1.0
- 🎉 初始版本发布
- ✅ 基础一键处理功能

## 相关工具

- **图集生成器**：单独生成图集，支持预览
- **材质图集替换器**：单独执行材质替换，支持详细分析

---

**开发者**: HiHi2 Atlas Tools Team  
**最后更新**: 2026-01