# 图集生成器（Atlas Generator）

## 概述

图集生成器是一个强大的 Unity Editor 工具，用于将多张散图自动打包生成优化的纹理图集。工具采用 MaxRects 算法实现高效的矩形装箱，支持自动/自定义两种路径模式，提供实时预览和高级图集查看功能。

## 功能特性

### 核心功能
- **智能图集打包**：使用 MaxRects 装箱算法，自动计算最优图集尺寸
- **双路径模式**：支持自动模式和自定义模式，灵活适配不同工作流
- **实时预览**：生成前可预览图集布局、空白率和包含的纹理列表
- **高级预览选项**：提供类似 Inspector 的纹理预览，支持 RGB/Alpha 通道切换和 Mipmap 层级查看
- **自动降维优化**：自动减去 Padding 占用空间，提高图集利用率
- **多图集支持**：当单图集无法容纳时，可自动生成多张图集
- **法线贴图过滤**：自动识别并跳过法线贴图（Normal Map）

### 路径模式

#### 自动模式（Auto Mode）
- **输入路径**：拖拽选择任意文件夹（通常为服装项目的 Texture 文件夹）
- **输出路径**：自动生成为 `[父级目录]/Lod/Texture`
- **适用场景**：标准项目结构，快速生成图集

#### 自定义模式（Custom Mode）
- **Texture 源路径**：自由选择贴图源文件夹
- **图集输出路径**：自由选择图集和配置文件保存位置
- **适用场景**：非标准项目结构，需要灵活配置路径的场景

## 使用方法

### 方式一：快捷菜单（推荐）
1. 在 Project 窗口中选中任意包含贴图的文件夹
2. 右键 → `图集生成替换` → `生成优化图集`
3. 窗口会自动打开并填充该文件夹路径

### 方式二：工具菜单
1. 顶部菜单栏 → `Tools` → `图集生成替换` → `图集生成器窗口`
2. 手动拖拽或选择文件夹

### 操作步骤

#### 基础流程
1. **选择路径模式**：根据项目需求选择自动或自定义模式
2. **配置源路径**：
   - 自动模式：拖拽文件夹或点击「使用当前选中」
   - 自定义模式：分别选择 Texture 源路径和输出路径
3. **配置图集参数**：
   - 加载或创建 AtlasGeneratorSettings 配置资源
   - 调整 Padding、最大空白率、尺寸范围等参数
4. **预览图集**：点击「预览图集」按钮查看生成效果
5. **生成图集**：确认无误后点击「生成图集」保存到磁盘

#### 预览功能
预览结果显示以下信息：
- **图集纹理**：可视化图集布局
- **尺寸和空白率**：图集分辨率和空间利用率
- **包含的图片列表**：展开查看每张图片的详细信息
  - 原始尺寸（应用 MaxSize 后）
  - 缩放后无 Padding 尺寸
  - 含 Padding 占用尺寸
  - 点击「定位」可在 Project 窗口中高亮源文件

#### 高级预览选项
展开「高级预览选项」可获得更强大的查看能力：
- **纹理信息**：格式、尺寸、Mipmap 级数、内存占用
- **RGB/Alpha 切换**：独立查看颜色或透明度通道
- **Mipmap 滑块**：查看不同 Mipmap 层级的效果
- **背景网格**：透明背景便于检查边缘质量

## 配置参数详解

### AtlasGeneratorSettings
| 参数 | 说明 | 推荐值 | 取值范围 |
|-----|------|--------|---------|
| **Padding** | 图片间距（像素） | 2 | 0-16，必须为偶数 |
| **最大空白率** | 允许的最大空白百分比 | 15% | 0-50% |
| **最小图集尺寸** | 图集最小边长 | 256 | 32/64/128/256/512/1024/2048/4096 |
| **最大图集尺寸** | 图集最大边长 | 2048 | 同上 |
| **允许多张图集** | 是否允许生成多个图集 | 启用 | 布尔值 |
| **图集名前缀** | 图集文件名前缀 | 项目名 | 字符串 |

### Padding 作用说明
- **防止渗色**：避免相邻纹理在 Mipmap 或采样时互相干扰
- **边缘质量**：为边缘扩展提供空间，减少黑边或颜色污染
- **性能平衡**：过大的 Padding 会降低空间利用率，过小可能产生视觉瑕疵

### 空白率（Wastage）计算
空白率 = (图集总面积 - 所有图片占用面积) / 图集总面积 × 100%
- **低空白率**（<10%）：空间利用率高，但可能需要更大尺寸
- **中等空白率**（10-20%）：平衡空间利用和图集尺寸（推荐）
- **高空白率**（>20%）：可能存在优化空间

## 输出文件

### 生成的资源
1. **图集纹理**（PNG 格式）
   - 命名规则：`{父文件夹名}_{索引}.png`
   - 导入设置：sRGB、开启 Mipmap、无压缩、支持透明

2. **图集配置**（AtlasConfig ScriptableObject）
   - 命名规则：`{父文件夹名}_{索引}.asset`
   - 存储内容：
     - 图集纹理引用
     - 每张图片的 UV 坐标
     - 原始尺寸、缩放尺寸、含 Padding 尺寸
     - Padding 值、空白率等元数据

### 输出目录结构
[父级目录]/ 
└── Lod/ 
└── Texture/ 
├── ClothingName_0.png 
├── ClothingName_0.asset 
├── ClothingName_1.png 
└── ClothingName_1.asset
## 技术细节

### MaxRects 装箱算法
- **Best Short Side Fit (BSSF)**：优先选择短边剩余最小的位置
- **动态矩形分割**：已占用区域会触发自由矩形分割
- **剩余矩形修剪**：移除完全包含在其他矩形内的冗余矩形
- **贪心降序排列**：按面积从大到小排序纹理，提高装箱成功率

### 自动降维机制
为了在保持原始纹理质量的同时为 Padding 腾出空间：
1. 读取纹理的实际尺寸（考虑 MaxSize 限制）
2. 计算降维后尺寸：`finalSize = actualSize - padding × 2`
3. 创建降维后的可读副本用于打包
4. 在图集中为每张图预留 Padding 空间
5. 使用边缘像素填充 Padding 区域（防止渗色）

### 纹理导入优化
收集纹理时自动设置：
- **Readable**：启用读取权限（临时）
- **Alpha Source**：从源文件读取透明度
- **Alpha Is Transparency**：启用透明度处理

生成后的图集设置：
- **Texture Type**：Default
- **sRGB**：启用（适配 PBR 流程）
- **Mipmap**：启用
- **Compression**：无压缩（保证质量）

## 常见问题

### Q1: 预览成功但生成失败？
**A:** 检查输出路径是否有写入权限，或路径是否被其他进程占用。

### Q2: 空白率过高如何优化？
**A:** 
- 降低 Padding 值（如果视觉效果允许）
- 提高最大空白率阈值
- 允许多张图集分摊
- 检查是否存在尺寸差异过大的纹理

### Q3: 某些纹理未被打包？
**A:** 
- 确认不是法线贴图（会被自动跳过）
- 检查纹理是否可读（工具会自动设置）
- 查看 Console 是否有错误日志

### Q4: 图集边缘出现黑边或杂色？
**A:** 增加 Padding 值，推荐 2-4 像素。

### Q5: 生成的图集模糊？
**A:** 检查源纹理的 Max Size 设置，可能被压缩了。

## 性能建议

- **推荐纹理数量**：每个图集 10-50 张
- **推荐单张尺寸**：64x64 到 1024x1024
- **推荐图集尺寸**：1024x1024 或 2048x2048
- **Padding 推荐值**：2-4 像素

## 版本历史

### v3.0（当前版本）
- ✨ 新增自定义路径模式
- ✨ 新增高级预览功能（RGB/Alpha/Mipmap）
- ✨ 新增图片列表定位功能
- 🔧 优化路径选择交互，支持拖拽 DefaultAsset
- 🔧 改进 Padding 处理逻辑，修复边缘填充算法
- 🐛 修复自定义模式输出路径不生效问题

### v2.0
- ✨ 引入 MaxRects 装箱算法
- ✨ 支持多图集生成
- ✨ 添加自动降维机制

### v1.0
- 🎉 初始版本发布
- ✅ 基础图集生成功能

## 相关工具

- **材质图集替换器**：自动将材质球的散图替换为图集
- **一键图集处理器**：一键完成图集生成和材质替换

---

**开发者**: HiHi2 Atlas Tools Team  
**最后更新**: 2026-01